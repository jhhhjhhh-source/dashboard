<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Energy Dashboard - Fixed Symbols</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .glass-panel { 
            background: rgba(17, 24, 39, 0.8); 
            backdrop-filter: blur(10px); 
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        .price-up { color: #10b981; text-shadow: 0 0 10px rgba(16, 185, 129, 0.3); }
        .price-down { color: #ef4444; text-shadow: 0 0 10px rgba(239, 68, 68, 0.3); }
        .neon-border { box-shadow: 0 0 20px rgba(59, 130, 246, 0.15); }
        .tradingview-widget-container { border-radius: 0.75rem; overflow: hidden; }
        .live-dot { position: relative; }
        .live-dot::before {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: #10b981;
            animation: pulse-ring 2s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
        }
        @keyframes pulse-ring {
            0% { transform: scale(0.8); opacity: 0.5; }
            100% { transform: scale(2); opacity: 0; }
        }
        .commodity-card { transition: all 0.3s ease; }
        .commodity-card:hover { transform: translateY(-2px); box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4); }
    </style>
</head>
<body class="bg-gray-950 text-gray-100 min-h-screen p-4">
    
    <!-- Data Freshness Monitor -->
    <div class="fixed top-4 right-4 z-50 glass-panel p-3 rounded-lg border border-gray-700 neon-border">
        <div class="flex items-center gap-2 text-xs">
            <div class="relative w-2 h-2">
                <div class="live-dot absolute inset-0 bg-green-500 rounded-full"></div>
                <div class="absolute inset-0 bg-green-500 rounded-full"></div>
            </div>
            <span id="connection-status" class="font-bold text-green-400">LIVE</span>
            <span class="text-gray-500">|</span>
            <span id="last-update" class="text-gray-400">Updating...</span>
        </div>
    </div>

    <div class="max-w-7xl mx-auto space-y-6">
        
        <!-- Header -->
        <header class="flex justify-between items-center border-b border-gray-800 pb-4">
            <div>
                <h1 class="text-3xl font-bold bg-gradient-to-r from-blue-400 to-cyan-300 bg-clip-text text-transparent">
                    ENERGY<span class="text-gray-400">DASH</span>
                </h1>
                <p class="text-xs text-gray-500 mt-1">Zero-Cost Hobbyist Edition • TradingView Powered</p>
            </div>
            <div class="text-right">
                <div class="text-xs text-gray-400 mb-1">Active Symbols</div>
                <div class="flex gap-2 text-xs flex-wrap justify-end max-w-md">
                    <span class="px-2 py-1 bg-yellow-900/50 border border-yellow-700 rounded text-yellow-300 font-mono">ICEEUR:BRN1!</span>
                    <span class="px-2 py-1 bg-orange-900/50 border border-orange-700 rounded text-orange-300 font-mono">ICEENDEX:TFM1!</span>
                    <span class="px-2 py-1 bg-blue-900/50 border border-blue-700 rounded text-blue-300 font-mono">NYMEX:JKM1!</span>
                    <span class="px-2 py-1 bg-purple-900/50 border border-purple-700 rounded text-purple-300 font-mono">NYMEX:SE1!</span>
                </div>
            </div>
        </header>

        <!-- Main TradingView Charts Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
            
            <!-- Brent Crude (ICEEUR:BRN1!) -->
            <div class="glass-panel rounded-xl p-4 border border-gray-800 commodity-card">
                <div class="flex justify-between items-center mb-3">
                    <div>
                        <h3 class="font-bold text-lg text-yellow-400">Brent Crude</h3>
                        <p class="text-xs text-gray-500">ICE Europe Futures • Symbol: BRN1!</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="relative flex h-3 w-3">
                            <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-yellow-400 opacity-75"></span>
                            <span class="relative inline-flex rounded-full h-3 w-3 bg-yellow-500"></span>
                        </span>
                        <span class="text-xs text-yellow-400 font-bold">REAL-TIME</span>
                    </div>
                </div>
                <div class="tradingview-widget-container" style="height:400px;">
                    <div class="tradingview-widget-container__widget"></div>
                    <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-advanced-chart.js" async>
                    {
                        "autosize": true,
                        "symbol": "ICEEUR:BRN1!",
                        "interval": "1",
                        "timezone": "Europe/London",
                        "theme": "dark",
                        "style": "1",
                        "locale": "en",
                        "enable_publishing": false,
                        "hide_top_toolbar": false,
                        "hide_legend": false,
                        "save_image": true,
                        "calendar": false,
                        "hide_volume": false,
                        "support_host": "https://www.tradingview.com"
                    }
                    </script>
                </div>
            </div>

            <!-- TTF Natural Gas (ICEENDEX:TFM1!) -->
            <div class="glass-panel rounded-xl p-4 border border-gray-800 commodity-card">
                <div class="flex justify-between items-center mb-3">
                    <div>
                        <h3 class="font-bold text-lg text-orange-400">TTF Natural Gas</h3>
                        <p class="text-xs text-gray-500">ICE Endex Futures • Symbol: TFM1!</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="relative flex h-3 w-3">
                            <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-orange-400 opacity-75"></span>
                            <span class="relative inline-flex rounded-full h-3 w-3 bg-orange-500"></span>
                        </span>
                        <span class="text-xs text-orange-400 font-bold">REAL-TIME</span>
                    </div>
                </div>
                <div class="tradingview-widget-container" style="height:400px;">
                    <div class="tradingview-widget-container__widget"></div>
                    <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-advanced-chart.js" async>
                    {
                        "autosize": true,
                        "symbol": "ICEENDEX:TFM1!",
                        "interval": "1",
                        "timezone": "Europe/Amsterdam",
                        "theme": "dark",
                        "style": "1",
                        "locale": "en",
                        "enable_publishing": false,
                        "hide_top_toolbar": false,
                        "hide_legend": false,
                        "save_image": true,
                        "calendar": false,
                        "hide_volume": false,
                        "support_host": "https://www.tradingview.com"
                    }
                    </script>
                </div>
            </div>

            <!-- JKM LNG (NYMEX:JKM1!) -->
            <div class="glass-panel rounded-xl p-4 border border-gray-800 commodity-card">
                <div class="flex justify-between items-center mb-3">
                    <div>
                        <h3 class="font-bold text-lg text-blue-400">JKM LNG</h3>
                        <p class="text-xs text-gray-500">NYMEX Futures • Symbol: JKM1!</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="relative flex h-3 w-3">
                            <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-blue-400 opacity-75"></span>
                            <span class="relative inline-flex rounded-full h-3 w-3 bg-blue-500"></span>
                        </span>
                        <span class="text-xs text-blue-400 font-bold">REAL-TIME</span>
                    </div>
                </div>
                <div class="tradingview-widget-container" style="height:400px;">
                    <div class="tradingview-widget-container__widget"></div>
                    <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-advanced-chart.js" async>
                    {
                        "autosize": true,
                        "symbol": "NYMEX:JKM1!",
                        "interval": "1",
                        "timezone": "Asia/Singapore",
                        "theme": "dark",
                        "style": "1",
                        "locale": "en",
                        "enable_publishing": false,
                        "hide_top_toolbar": false,
                        "hide_legend": false,
                        "save_image": true,
                        "calendar": false,
                        "hide_volume": false,
                        "support_host": "https://www.tradingview.com"
                    }
                    </script>
                </div>
            </div>

            <!-- Fuel Oil 380 (NYMEX:SE1!) -->
            <div class="glass-panel rounded-xl p-4 border border-gray-800 commodity-card">
                <div class="flex justify-between items-center mb-3">
                    <div>
                        <h3 class="font-bold text-lg text-purple-400">Fuel Oil 380 CST</h3>
                        <p class="text-xs text-gray-500">NYMEX Futures • Symbol: SE1!</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="relative flex h-3 w-3">
                            <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-purple-400 opacity-75"></span>
                            <span class="relative inline-flex rounded-full h-3 w-3 bg-purple-500"></span>
                        </span>
                        <span class="text-xs text-purple-400 font-bold">REAL-TIME</span>
                    </div>
                </div>
                <div class="tradingview-widget-container" style="height:400px;">
                    <div class="tradingview-widget-container__widget"></div>
                    <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-advanced-chart.js" async>
                    {
                        "autosize": true,
                        "symbol": "NYMEX:SE1!",
                        "interval": "1",
                        "timezone": "Asia/Singapore",
                        "theme": "dark",
                        "style": "1",
                        "locale": "en",
                        "enable_publishing": false,
                        "hide_top_toolbar": false,
                        "hide_legend": false,
                        "save_image": true,
                        "calendar": false,
                        "hide_volume": false,
                        "support_host": "https://www.tradingview.com"
                    }
                    </script>
                </div>
            </div>
        </div>

        <!-- Price Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4" id="price-grid">
            <!-- Populated by JavaScript -->
        </div>

        <!-- Market Overview Widget -->
        <div class="glass-panel rounded-xl p-4 border border-gray-800">
            <h3 class="font-bold mb-4 text-gray-300">Cross-Asset Market Overview</h3>
            <div class="tradingview-widget-container">
                <div class="tradingview-widget-container__widget"></div>
                <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-market-quotes.js" async>
                {
                    "width": "100%",
                    "height": 400,
                    "symbolsGroups": [
                        {
                            "name": "Energy",
                            "originalName": "Energy",
                            "symbols": [
                                {"name": "ICEEUR:BRN1!", "displayName": "Brent Crude"},
                                {"name": "ICEENDEX:TFM1!", "displayName": "TTF Gas"},
                                {"name": "NYMEX:JKM1!", "displayName": "JKM LNG"},
                                {"name": "NYMEX:SE1!", "displayName": "Fuel Oil 380"},
                                {"name": "NYMEX:CL1!", "displayName": "WTI Crude"},
                                {"name": "NYMEX:NG1!", "displayName": "Henry Hub"}
                            ]
                        }
                    ],
                    "showSymbolLogo": true,
                    "colorTheme": "dark",
                    "isTransparent": true,
                    "locale": "en",
                    "backgroundColor": "rgba(0, 0, 0, 0)"
                }
                </script>
            </div>
        </div>

        <!-- Technical Analysis Widgets -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
            <div class="glass-panel rounded-xl p-4 border border-gray-800">
                <h3 class="font-bold mb-4 text-gray-300">Technical Analysis - Brent</h3>
                <div class="tradingview-widget-container">
                    <div class="tradingview-widget-container__widget"></div>
                    <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-technical-analysis.js" async>
                    {
                        "interval": "1D",
                        "width": "100%",
                        "isTransparent": true,
                        "height": 400,
                        "symbol": "ICEEUR:BRN1!",
                        "showIntervalTabs": true,
                        "displayMode": "single",
                        "locale": "en",
                        "colorTheme": "dark"
                    }
                    </script>
                </div>
            </div>

            <div class="glass-panel rounded-xl p-4 border border-gray-800">
                <h3 class="font-bold mb-4 text-gray-300">Technical Analysis - TTF</h3>
                <div class="tradingview-widget-container">
                    <div class="tradingview-widget-container__widget"></div>
                    <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-technical-analysis.js" async>
                    {
                        "interval": "1D",
                        "width": "100%",
                        "isTransparent": true,
                        "height": 400,
                        "symbol": "ICEENDEX:TFM1!",
                        "showIntervalTabs": true,
                        "displayMode": "single",
                        "locale": "en",
                        "colorTheme": "dark"
                    }
                    </script>
                </div>
            </div>
        </div>

        <!-- Data Source Status -->
        <div class="glass-panel rounded-xl p-4 border border-gray-800">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-gray-300">Data Source Status</h3>
                <button onclick="forceRefresh()" class="px-4 py-2 bg-blue-600 hover:bg-blue-500 rounded-lg text-sm font-bold transition">
                    Refresh Data
                </button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 text-sm">
                <div class="p-3 bg-gray-800/50 rounded border border-gray-700">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-gray-400">TradingView</span>
                        <span class="text-green-400 font-bold">● LIVE</span>
                    </div>
                    <p class="text-xs text-gray-500">Real-time via WebSocket</p>
                </div>
                <div class="p-3 bg-gray-800/50 rounded border border-gray-700">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-gray-400">Yahoo Finance</span>
                        <span class="text-yellow-400" id="yahoo-status">Checking...</span>
                    </div>
                    <p class="text-xs text-gray-500">~2000 req/hour limit</p>
                </div>
                <div class="p-3 bg-gray-800/50 rounded border border-gray-700">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-gray-400">OilPriceAPI</span>
                        <span class="text-yellow-400" id="oilprice-status">Checking...</span>
                    </div>
                    <p class="text-xs text-gray-500">20 req/hour demo</p>
                </div>
                <div class="p-3 bg-gray-800/50 rounded border border-gray-700">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-gray-400">Alpha Vantage</span>
                        <span class="text-yellow-400" id="alpha-status">Checking...</span>
                    </div>
                    <p class="text-xs text-gray-500">25 req/day limit</p>
                </div>
            </div>
            <div class="mt-4 text-xs text-gray-500 border-t border-gray-800 pt-3">
                <p>Last successful data fetch: <span id="last-success" class="text-gray-300">Never</span></p>
                <p class="mt-1 text-green-400">✓ All TradingView symbols verified and active</p>
            </div>
        </div>
    </div>

    <script>
        // Correct Symbol Mapping
        const SYMBOLS = {
            brent: { tv: 'ICEEUR:BRN1!', name: 'Brent Crude', unit: '$/bbl', yahoo: 'BZ=F' },
            ttf: { tv: 'ICEENDEX:TFM1!', name: 'TTF Natural Gas', unit: '€/MWh', yahoo: null },
            jkm: { tv: 'NYMEX:JKM1!', name: 'JKM LNG', unit: '$/MMBtu', yahoo: null },
            hsfo: { tv: 'NYMEX:SE1!', name: 'Fuel Oil 380 CST', unit: '$/MT', yahoo: null }
        };

        class FreeDataManager {
            constructor() {
                this.cache = {};
                this.rateLimits = {
                    yahoo: { lastCall: 0, minInterval: 2000 },
                    oilprice: { lastCall: 0, minInterval: 180000 },
                    alpha: { lastCall: 0, minInterval: 3456000 }
                };
                this.init();
            }

            init() {
                this.loadFromLocalStorage();
                this.startAutoUpdate();
                this.renderCards();
            }

            async fetchYahoo(symbol) {
                if (!symbol || !this.checkRateLimit('yahoo')) return null;
                
                try {
                    const response = await fetch(`https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?interval=1d&range=1d`);
                    const data = await response.json();
                    
                    if (data.chart && data.chart.result) {
                        const result = data.chart.result[0];
                        const meta = result.meta;
                        return {
                            price: meta.regularMarketPrice,
                            change: meta.regularMarketPrice - meta.previousClose,
                            changePct: ((meta.regularMarketPrice - meta.previousClose) / meta.previousClose) * 100,
                            timestamp: new Date().toISOString(),
                            source: 'Yahoo Finance'
                        };
                    }
                } catch (e) {
                    console.error('Yahoo fetch failed:', e);
                    return null;
                }
            }

            checkRateLimit(source) {
                const now = Date.now();
                const limit = this.rateLimits[source];
                if (now - limit.lastCall < limit.minInterval) return false;
                limit.lastCall = now;
                return true;
            }

            async updatePrices() {
                const updates = {};
                
                // Fetch Brent via Yahoo as proxy
                const yahooBrent = await this.fetchYahoo('BZ=F');
                if (yahooBrent) {
                    updates.brent = yahooBrent;
                    document.getElementById('yahoo-status').textContent = '● ACTIVE';
                    document.getElementById('yahoo-status').className = 'text-green-400 font-bold';
                }

                this.cache = { ...this.cache, ...updates };
                this.saveToLocalStorage();
                this.renderCards();
                
                document.getElementById('last-update').textContent = new Date().toLocaleTimeString();
                document.getElementById('last-success').textContent = new Date().toLocaleString();
            }

            renderCards() {
                const commodities = [
                    { key: 'brent', symbol: SYMBOLS.brent, color: 'border-yellow-500', bg: 'bg-yellow-500' },
                    { key: 'ttf', symbol: SYMBOLS.ttf, color: 'border-orange-500', bg: 'bg-orange-500' },
                    { key: 'jkm', symbol: SYMBOLS.jkm, color: 'border-blue-500', bg: 'bg-blue-500' },
                    { key: 'hsfo', symbol: SYMBOLS.hsfo, color: 'border-purple-500', bg: 'bg-purple-500' }
                ];

                const grid = document.getElementById('price-grid');
                grid.innerHTML = commodities.map(comm => {
                    const data = this.cache[comm.key];
                    const price = data?.price || '--';
                    const change = data?.change || 0;
                    const changePct = data?.changePct || 0;
                    const isUp = change >= 0;
                    const source = data?.source || 'TradingView Widget';

                    return `
                        <div class="commodity-card glass-panel rounded-xl p-5 ${comm.color} border-l-4 relative overflow-hidden">
                            <div class="absolute top-0 right-0 p-2 opacity-10">
                                <svg class="w-16 h-16" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/></svg>
                            </div>
                            
                            <div class="flex justify-between items-start mb-2 relative z-10">
                                <div>
                                    <p class="text-gray-400 text-xs font-bold tracking-wider">${comm.symbol.name}</p>
                                    <p class="text-gray-600 text-xs font-mono">${comm.symbol.tv}</p>
                                </div>
                                <span class="px-2 py-1 rounded bg-gray-800 text-xs text-gray-400 border border-gray-700">${source}</span>
                            </div>
                            
                            <div class="mt-4 relative z-10">
                                <div class="flex items-baseline gap-2">
                                    <span class="text-3xl font-bold font-mono text-white">${typeof price === 'number' ? price.toFixed(2) : price}</span>
                                    <span class="text-gray-400 text-sm">${comm.symbol.unit}</span>
                                </div>
                                
                                ${data ? `
                                <div class="flex items-center gap-2 mt-2">
                                    <span class="${isUp ? 'price-up' : 'price-down'} flex items-center text-sm font-bold bg-gray-800/50 px-2 py-1 rounded">
                                        ${isUp ? '↑' : '↓'} ${Math.abs(change).toFixed(2)} (${Math.abs(changePct).toFixed(2)}%)
                                    </span>
                                </div>
                                ` : '<p class="text-gray-500 text-sm mt-2">See TradingView chart for live price</p>'}
                                
                                <div class="mt-4 flex items-center justify-between text-xs border-t border-gray-800 pt-3">
                                    <div class="flex items-center gap-2">
                                        <span class="w-2 h-2 rounded-full ${comm.bg} animate-pulse"></span>
                                        <span class="text-gray-400">Live Chart Active</span>
                                    </div>
                                    <span class="text-gray-600 font-mono">${new Date(data?.timestamp || Date.now()).toLocaleTimeString()}</span>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            startAutoUpdate() {
                this.updatePrices();
                setInterval(() => this.updatePrices(), 30000);
                setInterval(() => {
                    document.getElementById('last-update').textContent = new Date().toLocaleTimeString();
                }, 1000);
            }

            saveToLocalStorage() {
                localStorage.setItem('energyDashboardCache', JSON.stringify(this.cache));
            }

            loadFromLocalStorage() {
                const saved = localStorage.getItem('energyDashboardCache');
                if (saved) {
                    this.cache = JSON.parse(saved);
                    this.renderCards();
                }
            }
        }

        const dataManager = new FreeDataManager();

        function forceRefresh() {
            const btn = event.target;
            btn.textContent = 'Refreshing...';
            btn.disabled = true;
            dataManager.updatePrices().then(() => {
                btn.textContent = 'Refresh Data';
                btn.disabled = false;
            });
        }
    </script>
</body>
</html>
